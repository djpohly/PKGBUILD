# $Id$
# Maintainer: Ionut Biru <ibiru@archlinux.org>

_pkgname=gtk3
pkgname=$_pkgname-jjk
pkgver=3.18.5
pkgrel=1
pkgdesc="GObject-based multi-platform GUI toolkit (v3)"
arch=(i686 x86_64)
url="http://www.gtk.org/"
install=gtk3.install
depends=(atk cairo gtk-update-icon-cache libxcursor libxinerama libxrandr
         libxi libepoxy libxcomposite libxdamage pango shared-mime-info
         at-spi2-atk adwaita-icon-theme)
makedepends=(gobject-introspection mesa gtk-doc)
provides=($_pkgname)
conflicts=($_pkgname)
options=('!strip' 'debug')
license=(LGPL)
source=(http://ftp.gnome.org/pub/gnome/sources/gtk+/${pkgver%.*}/gtk+-$pkgver.tar.xz
        settings.ini
        0001-Add-class-focused-row-to-the-focused-row-regardless-.patch
        0001-Add-GTK_IS_JJK.patch
        0001-Add-gtk_tree_selection_invert_range.patch
        0001-Allow-to-disable-full-row-highlight-on-selection.patch
        0001-cellrenderertext-Fix-possible-overwriting-of-markup.patch
        0001-fix-typo.patch
        0001-menu-Fix-possible-leak-on-destroy.patch
        0001-revert-changes-to-GtkMessageDialog.patch
        0001-Revert-treeview-Store-editable-position-differently.patch
        0001-Some-fixes-in-gtk_tree_view_is_blank_at_pos.patch
        0001-tooltip-Fix-possibly-briefly-appearing-at-0x0.patch
        0001-treemodel-Fix-gtk_tree_path_up-making-path-invalid.patch
        0001-treeview-Add-gtk_tree_view_set_focused_row.patch
        0001-treeview-Add-signal-test-rubber-banding.patch
        0001-treeview-Avoid-calling-do_validate_rows-if-not-neede.patch
        0001-treeview-Better-resizing-with-expand-columns.patch
        0001-treeview-Fix-only-headers-being-refreshed-on-validat.patch
        0001-treeview-Fix-possible-column-rendering-issue.patch
        0001-treeview-Fix-prelight-re-gesture-refactoring.patch
        0001-treeview-Remove-some-dead-code.patch
        0002-Add-gtk_tree_view_is_blank_at_pos_full.patch
        0002-menu-Add-helper-gtk_menu_popup_and_destroy.patch
        0002-treeview-Add-gtk_tree_view_set_row_class_column.patch
        0002-treeview-Add-signal-rubber-banding-active-and-gtk_tr.patch
        0002-treeview-Fix-visual-glitch-on-row-inserted.patch
        0003-treeview-Add-GtkTreeBoxable.patch
        0003-treeview-Change-how-toggle-in-handled-on-rubber-band.patch
        0004-treeview-Add-button-in-test-rubber-banding.patch
        0005-treeview-Add-skip_next_button_press.patch
        fix-708148.patch)
sha256sums=('107aeb9a4244ce3c044becdd6dffc32d83202595181597180d4c736302a71852'
            'de961084b35507da5415640db733457161e1672ee54639828dfa399ea3d220b1'
            '551cfe72e9b76deac2fca33580a03e71293ab8a6aa8a20c2288d279827723872'
            'b225d99ac575ec3bde38f8513e7bdc94c739b7a6db9def5705d99059130a6d85'
            '4622adb68574d458a2b730a5e27255ba023ecbe47d46e34309f5efd2375a067b'
            '93209e1760dd80cc1d5c65d6bd815421daed2fb9acad0994f90b606e359bd68d'
            '2f4ca8752864af3bd805ba6561038057038dbad102319f2105e38eaa57e8be67'
            '112b430040c901bc70555056c7481e27d8b5136b530b7dfb384cddc304da6cc1'
            '203975b4089da60209c7a3d1763c32fa0004b43f28171afebe87216cae4e1451'
            'c4e4fb80fdf61e0f668e0b06d9e796a4de0ce98622d2b11697365fa4accf6d8f'
            'a56154ea0d9052b3eb82a3bb4131516332c3bf93af338f884f0d04d0cb3cff93'
            'd723e15c85881af0ab2c533743fb812f4155c097ed892aec3abac0dc071cd0da'
            '7fe917eb754b63118f704dbd87bc7a0a58f72bed2e80b7b05144e16e6080217b'
            '33278c6c68b1dab3703db7d89f0918685ed6344baddf41b6e44a6711d20b2d87'
            '5c246d0b1d7beb09e0f9aae0e831479c564cb484a92ba9b9aaf538b866e37282'
            'e7fd1f9f13178a3a0be0c34d913a25a6c816a55729f39af0ac1a8968df6098e3'
            'a854d78a62c213ed93906eaf2c06e5c88886e5d3f14c500db3f5a833709fbe6a'
            'fedaa92ed168a18d0536225c9958d72f95f146d87a52906b0f525a90cff38312'
            'fcb8065f7c125cb599000327cc55c1cee5f88df2743e68aa2223708e40e1a1c0'
            '21aa1550fffe7ac873429dc3345974600a9418951f52130860af9debd3a1e14a'
            'c45e5ae4a4ebbc76be58509c648aab21707e744dcb3b318000a83fe10b8612ef'
            'dcaaa0103c3a52db8e25ba415a03521b1595ba816fe4ce04891e8479084e037c'
            'eddceca8ab7cdb9f20bf115d66bc895cda4c6777ab80c94c8e8676b570848cca'
            '8de638e906451da35f4da6120745b8b905d206823945ed47ef042581a4a9c165'
            'a4d9a3f055f220714a3582626d8583302325ea5a0ac8e2436a6d533921f8969a'
            '93d5f7973e6d92f9432bcfc4d9e1046773399bd07ef4abc418f1869888aa3641'
            '88a8c649f9a97f7eefe5258bc8200031b423b4c3d9afc76f7939771933f9384d'
            '5e0b64f13fd5b7d3e5f91043fcbe488318b1839aa6045b6909236f3a891b94fe'
            'ed8fa2172615bb889e35a809941332db0b2cce148d0367a8d75bd06e98425166'
            'b114f0f4f134ed1c3dbe26dfba90e8eb869219997ad3e74b407ea80d19428f45'
            'a71d8abe00c0668933090b5c9307812d909108554b9305d9cd8154575c7b8d95'
            '8a8b500f6850466b646f788ee45756bbba21dea6f75babddca1d4b32ea1b0b03')

prepare() {
    cd "gtk+-$pkgver"

    patch -p1 -i ../0001-Add-class-focused-row-to-the-focused-row-regardless-.patch
    patch -p1 -i ../0001-Add-GTK_IS_JJK.patch
    patch -p1 -i ../0001-Add-gtk_tree_selection_invert_range.patch
    patch -p1 -i ../0001-Allow-to-disable-full-row-highlight-on-selection.patch
    patch -p1 -i ../0001-cellrenderertext-Fix-possible-overwriting-of-markup.patch
    patch -p1 -i ../0001-fix-typo.patch
    patch -p1 -i ../0001-menu-Fix-possible-leak-on-destroy.patch
    patch -p1 -i ../0001-revert-changes-to-GtkMessageDialog.patch
    patch -p1 -i ../0001-Revert-treeview-Store-editable-position-differently.patch
    patch -p1 -i ../0001-Some-fixes-in-gtk_tree_view_is_blank_at_pos.patch
    patch -p1 -i ../0001-tooltip-Fix-possibly-briefly-appearing-at-0x0.patch
    patch -p1 -i ../0001-treemodel-Fix-gtk_tree_path_up-making-path-invalid.patch
    patch -p1 -i ../0001-treeview-Add-gtk_tree_view_set_focused_row.patch
    patch -p1 -i ../0001-treeview-Add-signal-test-rubber-banding.patch
    patch -p1 -i ../0001-treeview-Avoid-calling-do_validate_rows-if-not-neede.patch
    patch -p1 -i ../0001-treeview-Better-resizing-with-expand-columns.patch
    patch -p1 -i ../0001-treeview-Fix-only-headers-being-refreshed-on-validat.patch
    patch -p1 -i ../0001-treeview-Fix-possible-column-rendering-issue.patch
    patch -p1 -i ../0001-treeview-Fix-prelight-re-gesture-refactoring.patch
    patch -p1 -i ../0001-treeview-Remove-some-dead-code.patch
    patch -p1 -i ../0002-Add-gtk_tree_view_is_blank_at_pos_full.patch
    patch -p1 -i ../0002-menu-Add-helper-gtk_menu_popup_and_destroy.patch
    patch -p1 -i ../0002-treeview-Add-gtk_tree_view_set_row_class_column.patch
    patch -p1 -i ../0002-treeview-Add-signal-rubber-banding-active-and-gtk_tr.patch
    patch -p1 -i ../0002-treeview-Fix-visual-glitch-on-row-inserted.patch
    patch -p1 -i ../0003-treeview-Add-GtkTreeBoxable.patch
    patch -p1 -i ../0003-treeview-Change-how-toggle-in-handled-on-rubber-band.patch
    patch -p1 -i ../0004-treeview-Add-button-in-test-rubber-banding.patch
    patch -p1 -i ../0005-treeview-Add-skip_next_button_press.patch
    patch -p1 -i ../fix-708148.patch

    NOCONFIGURE=1 ./autogen.sh
}

build() {
    cd "gtk+-$pkgver"

    CXX=/bin/false ./configure --prefix=/usr \
        --sysconfdir=/etc \
        --localstatedir=/var \
        --disable-schemas-compile \
        --disable-cups \
        --disable-colord \
        --enable-x11-backend

    #https://bugzilla.gnome.org/show_bug.cgi?id=655517
    sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool

    make
}

package() {
    cd "gtk+-$pkgver"
    make DESTDIR="$pkgdir" install
    rm -f "$pkgdir/usr/bin/gtk-update-icon-cache"
}
