# $Id$
# Maintainer: Ionut Biru <ibiru@archlinux.org>

_pkgname=gtk3
pkgname=$_pkgname-jjk
pkgver=3.14.4
pkgrel=1
pkgdesc="GObject-based multi-platform GUI toolkit (v3)"
arch=(i686 x86_64)
url="http://www.gtk.org/"
install=gtk3.install
depends=(atk cairo gtk-update-icon-cache libxcursor libxinerama libxrandr
         libxi libxcomposite libxdamage pango shared-mime-info at-spi2-atk
         adwaita-icon-theme)
makedepends=(gobject-introspection mesa gtk-doc)
provides=($_pkgname)
conflicts=($_pkgname)
options=('!strip' 'debug')
license=(LGPL)
source=(http://ftp.gnome.org/pub/gnome/sources/gtk+/${pkgver%.*}/gtk+-$pkgver.tar.xz
        settings.ini
        0001-Add-class-focused-row-to-the-focused-row-regardless-.patch
        0001-Add-GTK_IS_JJK.patch
        0001-Add-gtk_tree_selection_invert_range.patch
        0001-Allow-to-disable-full-row-highlight-on-selection.patch
        0001-cellrenderertext-Fix-possible-overwriting-of-markup.patch
        0001-menu-Fix-possible-leak-on-destroy.patch
        0001-revert-changes-to-GtkMessageDialog.patch
        0001-Revert-treeview-Store-editable-position-differently.patch
        0001-Some-fixes-in-gtk_tree_view_is_blank_at_pos.patch
        0001-tooltip-Fix-possibly-briefly-appearing-at-0x0.patch
        0001-treeview-Add-gtk_tree_view_set_focused_row.patch
        0001-treeview-Add-signal-test-rubber-banding.patch
        0001-treeview-Avoid-calling-do_validate_rows-if-not-neede.patch
        0001-treeview-Fix-possible-column-rendering-issue.patch
        0001-treeview-Fix-prelight-re-gesture-refactoring.patch
        0001-treeview-Remove-some-dead-code.patch
        0002-Add-gtk_tree_view_is_blank_at_pos_full.patch
        0002-menu-Add-helper-gtk_menu_popup_and_destroy.patch
        0002-treeview-Add-gtk_tree_view_set_row_class_column.patch
        0002-treeview-Add-signal-rubber-banding-active-and-gtk_tr.patch
        0002-treeview-Fix-visual-glitch-on-row-inserted.patch
        0003-treeview-Add-GtkTreeBoxable.patch
        0003-treeview-Change-how-toggle-in-handled-on-rubber-band.patch
        0004-treeview-Add-button-in-test-rubber-banding.patch
        0005-treeview-Add-skip_next_button_press.patch
        fix-708148.patch)
sha256sums=('a006c716d723dab0c623491566e3292af84c87d9198a30199051d23cfc7bef2f'
            'de961084b35507da5415640db733457161e1672ee54639828dfa399ea3d220b1'
            '92ecbde2ad7f66dae320813c61ef1ce394023e57a473a4313ed905eec426af6c'
            '8e13010bd17b6fa5edffe7ab6035258f603509a2517f405b6497b5e04293f3dd'
            '8c04f9b56982df10cb88467a1cbefaafd74f3f792768618ad45f2e3cff6871e1'
            '2c7a5954867806bebdf858cb359b26eebbf8309a8c2af2f8d3f6d347876b2d1e'
            '4f95549c08e4d4e6368ac94b3be07c3757cf958916cf482a1fda127442803f87'
            '22f12d30e0de2cfb0f626f098ac369d4e5867184c5df5373841feca739556cd0'
            'bcb07fa2c037d8ba3af91b309809f828b5dd7b0e8d92e0018729c28d0742493b'
            'b72cafd4fcd609cd93d29ca10261c1f627009ae636d65e24b8817cbc95595417'
            'bc8dd40271308fa4b7f016cb726e1006fd1c68f0f6fd41cd443f7bd38e8e8279'
            'b7896d38569a08f6d59292ce99cc8668c7dfcea4661d412dad559e7860e73458'
            '845aac068d82084fe875ea6104a85449020926bb8ea80bbe781adc1e1aa9500b'
            '85cd495035810e8f8fbc53c344bb02981215c574ed3eff812d4df0a87d0938a9'
            '1a34a3833a819f9eebea8e9359ac1e25f604b33fb906d8168e543ae1d655354e'
            'e023214a488e7dc32e67259e27a80eec0ebf066701379d323e04c9456f615b4e'
            '132a63f64e88dc42be3f996b45d93db5be16316f39bb936336eb5ca9fdc0b5e6'
            '771e9ce0e8958ba452aa7d1dadd62672cfa4ae59146728bc777ffe5b06446d0c'
            'e1d960124b31221f1eb8c81d1dbb460d601c5f29ad8d207e8784e80e57ef07cf'
            '9dbb1320f67f77189a6825f0065babc0f438b325a44066e0c38c79f483e77b44'
            'b6e66e9d435d87e315858964b60b1a4c5ff16b3c316ca7c162ff3f8f1cac2e56'
            '587d05a4c556283d9d8d771c5723deda72b71fdf370dba07e09537267d553563'
            '49274db1486a9f958411f271d52c55193a040614c9004d25bc58237844bcc700'
            '2d7785ea357adeb2bad4a7636478c4869f0b074d96fe08ed770e477d5fa06bcd'
            '9927fee455529fcf7c7bf70f2df2d92f1b9d14c0b628c57402fb2357925e83d0'
            'ccf1dedd24138a959bef9e1dc7ea7a1142741a38db0b55211aa2c39179b2ea25'
            '570d3790cf3cfc1e69f3b703ab38dba3eb3263954785e25fb3152c34cb7f3f17'
            '8a8b500f6850466b646f788ee45756bbba21dea6f75babddca1d4b32ea1b0b03')

prepare() {
    cd "gtk+-$pkgver"

    patch -p1 -i ../0001-Add-class-focused-row-to-the-focused-row-regardless-.patch
    patch -p1 -i ../0001-Add-GTK_IS_JJK.patch
    patch -p1 -i ../0001-Add-gtk_tree_selection_invert_range.patch
    patch -p1 -i ../0001-Allow-to-disable-full-row-highlight-on-selection.patch
    patch -p1 -i ../0001-cellrenderertext-Fix-possible-overwriting-of-markup.patch
    patch -p1 -i ../0001-menu-Fix-possible-leak-on-destroy.patch
    patch -p1 -i ../0001-revert-changes-to-GtkMessageDialog.patch
    patch -p1 -i ../0001-Revert-treeview-Store-editable-position-differently.patch
    patch -p1 -i ../0001-Some-fixes-in-gtk_tree_view_is_blank_at_pos.patch
    patch -p1 -i ../0001-tooltip-Fix-possibly-briefly-appearing-at-0x0.patch
    patch -p1 -i ../0001-treeview-Add-gtk_tree_view_set_focused_row.patch
    patch -p1 -i ../0001-treeview-Add-signal-test-rubber-banding.patch
    patch -p1 -i ../0001-treeview-Avoid-calling-do_validate_rows-if-not-neede.patch
    patch -p1 -i ../0001-treeview-Fix-possible-column-rendering-issue.patch
    patch -p1 -i ../0001-treeview-Fix-prelight-re-gesture-refactoring.patch
    patch -p1 -i ../0001-treeview-Remove-some-dead-code.patch
    patch -p1 -i ../0002-Add-gtk_tree_view_is_blank_at_pos_full.patch
    patch -p1 -i ../0002-menu-Add-helper-gtk_menu_popup_and_destroy.patch
    patch -p1 -i ../0002-treeview-Add-gtk_tree_view_set_row_class_column.patch
    patch -p1 -i ../0002-treeview-Add-signal-rubber-banding-active-and-gtk_tr.patch
    patch -p1 -i ../0002-treeview-Fix-visual-glitch-on-row-inserted.patch
    patch -p1 -i ../0003-treeview-Add-GtkTreeBoxable.patch
    patch -p1 -i ../0003-treeview-Change-how-toggle-in-handled-on-rubber-band.patch
    patch -p1 -i ../0004-treeview-Add-button-in-test-rubber-banding.patch
    patch -p1 -i ../0005-treeview-Add-skip_next_button_press.patch
    patch -p1 -i ../fix-708148.patch

    NOCONFIGURE=1 ./autogen.sh
}

build() {
    cd "gtk+-$pkgver"

    CXX=/bin/false ./configure --prefix=/usr \
        --sysconfdir=/etc \
        --localstatedir=/var \
        --enable-gtk2-dependency \
        --disable-schemas-compile \
        --disable-cups \
        --disable-colord \
        --enable-x11-backend

    #https://bugzilla.gnome.org/show_bug.cgi?id=655517
    sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool

    make
}

package() {
    cd "gtk+-$pkgver"
    make DESTDIR="$pkgdir" install
}
