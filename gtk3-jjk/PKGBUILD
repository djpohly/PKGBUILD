# $Id$
# Maintainer: Ionut Biru <ibiru@archlinux.org>

_pkgname=gtk3
pkgname=$_pkgname-jjk
pkgver=3.10.6
pkgrel=5
pkgdesc="GObject-based multi-platform GUI toolkit (v3)"
arch=(i686 x86_64)
url="http://www.gtk.org/"
install=gtk3.install
depends=(atk cairo gtk-update-icon-cache libxcursor libxinerama libxrandr
         libxi libxcomposite libxdamage pango shared-mime-info at-spi2-atk)
makedepends=(gobject-introspection mesa gtk-doc)
provides=($_pkgname)
conflicts=($_pkgname)
options=('!strip' 'debug')
license=(LGPL)
source=(http://ftp.gnome.org/pub/gnome/sources/gtk+/${pkgver%.*}/gtk+-$pkgver.tar.xz
        settings.ini
        0001-cellrenderertext-Fix-possible-overwriting-of-markup.patch
        0001-treestore-Fix-segfault-when-reordering-non-existing-.patch
        0001-Some-fixes-in-gtk_tree_view_is_blank_at_pos.patch
        0002-Add-gtk_tree_view_is_blank_at_pos_full.patch
        0001-Add-class-focused-row-to-the-focused-row-regardless-.patch
        0001-treeview-Add-gtk_tree_view_set_focused_row.patch
        0001-Allow-to-disable-full-row-highlight-on-selection.patch
        0002-treeview-Add-gtk_tree_view_set_row_class_column.patch
        0003-treeview-Add-GtkTreeBoxable.patch
        0001-Add-gtk_tree_selection_invert_range.patch
        0001-GtkTreeView-Fix-issues-when-removing-a-column.patch
        0001-Fix-scrolling-menu-not-working-properly-Bug-701077.patch
        0001-treeview-is_rubber_banding_active-only-based-on-stat.patch
        0002-treeview-Add-gtk_tree_view_start_rubber_banding.patch
        0003-treeview-Change-how-toggle-in-handled-on-rubber-band.patch
        0001-Fix-GtkToolButton-possibly-being-empty.patch
        0001-Revert-treeview-Store-editable-position-differently.patch
        0002-treeview-Fix-visual-glitch-on-row-inserted.patch
        0001-cellarea-Fix-possibly-getting-invalid-inner_area.patch
        0001-treeview-Fix-possible-column-rendering-issue.patch
        0001-treeview-Remove-some-dead-code.patch
        0001-tooltip-Fix-possibly-briefly-appearing-at-0x0.patch
        0001-treeview-Avoid-calling-do_validate_rows-if-not-neede.patch
        fix-708148.patch
        0001-menu-Fix-possible-leak-on-destroy.patch
        0001-treemodelfilter-Fix-using-wrong-path-on-row-deleted.patch
        0002-menu-Add-helper-gtk_menu_popup_and_destroy.patch
        0001-Add-GTK_IS_JJK.patch)
sha256sums=('3c24c57fc5cb7a5ea39d3a3ff7b12be63d7f21a52fd6f20f7b983e19b7b0268a'
            'de961084b35507da5415640db733457161e1672ee54639828dfa399ea3d220b1'
            '4f867b6aa6c81867fc56c0c6f9061d336234e23fa5bd8830032a904b05c04a41'
            'd67a39fde275e6d8be0bc52588e3d5c2140fa11fe73022deaad5c97990689811'
            '73758c97f017322c643e11bbbf85bc3f71d04af8156948e1d59678da2c12cd2a'
            'd918c7e9e08850a2f99eaa53d2e8d873c06d455a686238d5fbc940b59ada48d9'
            '38a18c144f7a22760a630bac4a67126d8d2889b75e76e1d1ca776715773d6fff'
            'b1d306806db164bdeec1b01c5b8b296fbec3173dff3941b013db134bb933788e'
            '25bc8d77fab4380f2b77ebb35ec6014030962f20be2335b7508bee0ca29beac5'
            'd8a7c975f271e35bbcb0e928d03de321351214c8d5f33616faabb6f1622fee74'
            '29323133db124c6034f51abbb7b4e6f86c1bb93eb159a68947ed3fe52c03b4d3'
            '222518481e63281a07bc54fe2c16ff94ee18110b1e51571316dcf35fdab79485'
            '78b89fa87ce876eeb6b9b4fce4ca439936ff0591e154a5615afb68e508a79207'
            '281eb70fdcec59859cd195b5a2afbb0abff8d846c9e1ac59ef59fe8cb8863d38'
            '92c7a768f9a9e664128d4671f9c50c08a091ac1765ffeb4d02e8c38b8d52e810'
            '095a83ce851772c659735e31cf9deedd298614c3ab47d2a977c0d17933bea3d6'
            '8d3216f839ac58dfef075785da70f07958aa0cfe13a438ed5c12b83163c1d0dc'
            'd7e42b16bf116b1395591a83f8c61e9e4e01ed9f370965ca690ec11a5255c99d'
            '0d6ac822cd0c0da859da4134cc2679bbf8c8a0c56f6dc76b72fbca6a8fd38e5a'
            '63a948d8c0451b87230319db0a6bb21fc1bd0c30bf9aa9d6e8fc6f198ad4e067'
            '6ace73fa96de82af6b2e752040bd886e821b33ecb151bbe6b7b51b8d8a106456'
            '590387fbd4701c511d2d91c1bbc0d18a03722be7602686da5bddd5293adcc57d'
            'c2ed59e8181ee3b8632e38e6517855a712818b0e6ee6868bafd0d1288e87c45d'
            '257a859231d4ff7f2b93cd733a90943af7c3961f50fa7fc515565eb2bea620a1'
            '7299909b4f7d4dad5f73dfd6b90b3896d1c6457a0242b19c18aca0648715ba7d'
            '8a8b500f6850466b646f788ee45756bbba21dea6f75babddca1d4b32ea1b0b03'
            '15f4e25b362f6f8df87914c8b5a95cbb96f4500ed00a36b9d9ccdf2f2cc11c21'
            'ded0df2553aab39315ce06b355bb6ba5ba320ba8b53919d716ccb9738725f0ca'
            '27d0afcc817559d55492b24118271d5ffd7331498fd085b7c70a9a10cbc36965'
            'bafcc5c42cad39566edf54bf30ddaa9fc37f47f326a7d0ae62b58206d84f43dc')
prepare() {
    cd "gtk+-$pkgver"

    patch -p1 -i ../0001-Add-GTK_IS_JJK.patch
    patch -p1 -i ../0001-Some-fixes-in-gtk_tree_view_is_blank_at_pos.patch
    patch -p1 -i ../0002-Add-gtk_tree_view_is_blank_at_pos_full.patch
    patch -p1 -i ../0001-treestore-Fix-segfault-when-reordering-non-existing-.patch
    patch -p1 -i ../0001-cellrenderertext-Fix-possible-overwriting-of-markup.patch
    patch -p1 -i ../0001-Add-class-focused-row-to-the-focused-row-regardless-.patch
    patch -p1 -i ../0001-treeview-Add-gtk_tree_view_set_focused_row.patch
    patch -p1 -i ../0001-Allow-to-disable-full-row-highlight-on-selection.patch
    patch -p1 -i ../0002-treeview-Add-gtk_tree_view_set_row_class_column.patch
    patch -p1 -i ../0003-treeview-Add-GtkTreeBoxable.patch
    patch -p1 -i ../0001-Add-gtk_tree_selection_invert_range.patch
    patch -p1 -i ../0001-GtkTreeView-Fix-issues-when-removing-a-column.patch
    patch -p1 -i ../0001-Fix-scrolling-menu-not-working-properly-Bug-701077.patch
    patch -p1 -i ../0001-treeview-is_rubber_banding_active-only-based-on-stat.patch
    patch -p1 -i ../0002-treeview-Add-gtk_tree_view_start_rubber_banding.patch
    patch -p1 -i ../0003-treeview-Change-how-toggle-in-handled-on-rubber-band.patch
    patch -p1 -i ../0001-Fix-GtkToolButton-possibly-being-empty.patch
    patch -p1 -i ../0001-Revert-treeview-Store-editable-position-differently.patch
    patch -p1 -i ../0002-treeview-Fix-visual-glitch-on-row-inserted.patch
    patch -p1 -i ../fix-708148.patch
    patch -p1 -i ../0001-cellarea-Fix-possibly-getting-invalid-inner_area.patch
    patch -p1 -i ../0001-treeview-Fix-possible-column-rendering-issue.patch
    patch -p1 -i ../0001-treeview-Remove-some-dead-code.patch
    patch -p1 -i ../0001-tooltip-Fix-possibly-briefly-appearing-at-0x0.patch
    patch -p1 -i ../0001-treeview-Avoid-calling-do_validate_rows-if-not-neede.patch
    patch -p1 -i ../0001-menu-Fix-possible-leak-on-destroy.patch
    patch -p1 -i ../0001-treemodelfilter-Fix-using-wrong-path-on-row-deleted.patch
    patch -p1 -i ../0002-menu-Add-helper-gtk_menu_popup_and_destroy.patch

    NOCONFIGURE=1 ./autogen.sh
}

build() {
    cd "gtk+-$pkgver"

    CXX=/bin/false ./configure --prefix=/usr \
        --sysconfdir=/etc \
        --localstatedir=/var \
        --enable-gtk2-dependency \
        --disable-schemas-compile \
        --disable-cups \
        --disable-colord \
        --enable-x11-backend

    #https://bugzilla.gnome.org/show_bug.cgi?id=655517
    sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool

    make
}

package() {
    cd "gtk+-$pkgver"
    make DESTDIR="$pkgdir" install

    install -Dm644 "$srcdir/settings.ini" "$pkgdir/usr/share/gtk-3.0/settings.ini"
}
