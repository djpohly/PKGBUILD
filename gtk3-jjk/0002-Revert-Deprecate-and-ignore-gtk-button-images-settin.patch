From 6c13d6427f40a75febb785fbdb7999dafb735ad9 Mon Sep 17 00:00:00 2001
From: Olivier Brunel <jjk@jjacky.com>
Date: Tue, 8 Oct 2013 15:03:22 +0200
Subject: [PATCH 2/2] Revert "Deprecate and ignore gtk-button-images setting"

This reverts commit 65c31629c38b3b1f49fb6f3327dc28819ffe0657.

Signed-off-by: Olivier Brunel <jjk@jjacky.com>
---
 gdk/wayland/gdkscreen-wayland.c |  1 +
 gdk/win32/gdkproperty-win32.c   |  1 +
 gdk/x11/gdksettings.c           |  1 +
 gtk/gtkbutton.c                 | 86 ++++++++++++++++++++++++++++++++++-------
 gtk/gtksettings.c               |  6 +--
 5 files changed, 78 insertions(+), 17 deletions(-)

diff --git a/gdk/wayland/gdkscreen-wayland.c b/gdk/wayland/gdkscreen-wayland.c
index 7fb14c6..15ec5ec 100644
--- a/gdk/wayland/gdkscreen-wayland.c
+++ b/gdk/wayland/gdkscreen-wayland.c
@@ -503,6 +503,7 @@ static TranslationEntry translations[] = {
   { "org.gnome.desktop.interface", "cursor-blink-time", "gtk-cursor-blink-time", G_TYPE_INT, { .i = 1200 } },
   { "org.gnome.desktop.interface", "cursor-blink-timeout", "gtk-cursor-blink-timeout", G_TYPE_INT, { .i = 3600 } },
   { "org.gnome.desktop.interface", "menus-have-icons", "gtk-menu-images", G_TYPE_BOOLEAN, { .b = FALSE } },
+  { "org.gnome.desktop.interface", "buttons-have-icons", "gtk-button-images", G_TYPE_BOOLEAN, { .b = FALSE } },
   { "org.gnome.desktop.interface", "gtk-im-module", "gtk-im-module", G_TYPE_STRING, { .s = "simple" } },
   { "org.gnome.desktop.interface", "enable-animations", "gtk-enable-animations", G_TYPE_BOOLEAN, { .b = TRUE } },
   { "org.gnome.settings-daemon.peripherals.mouse", "double-click", "gtk-double-click-time", G_TYPE_INT, { .i = 250 } },
diff --git a/gdk/win32/gdkproperty-win32.c b/gdk/win32/gdkproperty-win32.c
index 4bfc0c3..ce5b292 100644
--- a/gdk/win32/gdkproperty-win32.c
+++ b/gdk/win32/gdkproperty-win32.c
@@ -312,6 +312,7 @@ _gdk_win32_window_delete_property (GdkWindow *window,
   "Gtk/KeyThemeName\0"        "gtk-key-theme-name\0"
   "Gtk/Modules\0"             "gtk-modules\0"
   "Gtk/FileChooserBackend\0"  "gtk-file-chooser-backend\0"
+  "Gtk/ButtonImages\0"        "gtk-button-images\0"
   "Gtk/MenuImages\0"          "gtk-menu-images\0"
   "Gtk/MenuBarAccel\0"        "gtk-menu-bar-accel\0"
   "Gtk/CursorBlinkTimeout\0"  "gtk-cursor-blink-timeout\0"
diff --git a/gdk/x11/gdksettings.c b/gdk/x11/gdksettings.c
index d63a95e..5787de5 100644
--- a/gdk/x11/gdksettings.c
+++ b/gdk/x11/gdksettings.c
@@ -37,6 +37,7 @@ static const struct {
   {"Gtk/KeyThemeName",        "gtk-key-theme-name"},
   {"Gtk/Modules",             "gtk-modules"},
   {"Gtk/FileChooserBackend",  "gtk-file-chooser-backend"},
+  {"Gtk/ButtonImages",        "gtk-button-images"},
   {"Gtk/MenuImages",          "gtk-menu-images"},
   {"Gtk/MenuBarAccel",        "gtk-menu-bar-accel"},
   {"Gtk/CursorThemeName",     "gtk-cursor-theme-name"},
diff --git a/gtk/gtkbutton.c b/gtk/gtkbutton.c
index 20b15a6..735163e 100644
--- a/gtk/gtkbutton.c
+++ b/gtk/gtkbutton.c
@@ -364,8 +364,8 @@ gtk_button_class_init (GtkButtonClass *klass)
   /**
    * GtkButton:always-show-image:
    *
-   * If %TRUE, the button will show the image in addition to the
-   * label, if available.
+   * If %TRUE, the button will ignore the #GtkSettings:gtk-button-images
+   * setting and always show the image, if available.
    *
    * Use this property if the button would be useless or hard to use
    * without the image.
@@ -1137,10 +1137,15 @@ show_image (GtkButton *button)
   GtkButtonPrivate *priv = button->priv;
   gboolean show;
 
-  if (priv->label_text == NULL || priv->always_show_image)
-    show = TRUE;
+  if (priv->label_text && !priv->always_show_image)
+    {
+      GtkSettings *settings;
+
+      settings = gtk_widget_get_settings (GTK_WIDGET (button));        
+      g_object_get (settings, "gtk-button-images", &show, NULL);
+    }
   else
-    show = FALSE;
+    show = TRUE;
 
   return show;
 }
@@ -2617,12 +2622,53 @@ gtk_button_update_state (GtkButton *button)
   gtk_widget_set_state_flags (GTK_WIDGET (button), new_state, TRUE);
 }
 
+static void 
+show_image_change_notify (GtkButton *button)
+{
+  GtkButtonPrivate *priv = button->priv;
+
+  if (priv->image) 
+    {
+      if (show_image (button))
+	gtk_widget_show (priv->image);
+      else
+	gtk_widget_hide (priv->image);
+    }
+}
+
+static void
+traverse_container (GtkWidget *widget,
+		    gpointer   data)
+{
+  if (GTK_IS_BUTTON (widget))
+    show_image_change_notify (GTK_BUTTON (widget));
+  else if (GTK_IS_CONTAINER (widget))
+    gtk_container_forall (GTK_CONTAINER (widget), traverse_container, NULL);
+}
+
+static void
+gtk_button_setting_changed (GtkSettings *settings)
+{
+  GList *list, *l;
+
+  list = gtk_window_list_toplevels ();
+
+  for (l = list; l; l = l->next)
+    gtk_container_forall (GTK_CONTAINER (l->data), 
+			  traverse_container, NULL);
+
+  g_list_free (list);
+}
+
+
 static void
 gtk_button_screen_changed (GtkWidget *widget,
 			   GdkScreen *previous_screen)
 {
   GtkButton *button;
   GtkButtonPrivate *priv;
+  GtkSettings *settings;
+  gulong show_image_connection;
 
   if (!gtk_widget_has_screen (widget))
     return;
@@ -2637,6 +2683,20 @@ gtk_button_screen_changed (GtkWidget *widget,
       priv->button_down = FALSE;
       gtk_button_update_state (button);
     }
+
+  settings = gtk_widget_get_settings (widget);
+
+  show_image_connection = 
+    g_signal_handler_find (settings, G_SIGNAL_MATCH_FUNC, 0, 0,
+                           NULL, gtk_button_setting_changed, NULL);
+  
+  if (show_image_connection)
+    return;
+
+  g_signal_connect (settings, "notify::gtk-button-images",
+                    G_CALLBACK (gtk_button_setting_changed), NULL);
+
+  show_image_change_notify (button);
 }
 
 static void
@@ -2684,13 +2744,13 @@ gtk_button_grab_notify (GtkWidget *widget,
  * @button: a #GtkButton
  * @image: a widget to set as the image for the button
  *
- * Set the image of @button to the given widget. The image will be
- * displayed if the label text is %NULL or if
- * #GtkButton:always-show-image is %TRUE. You don't have to call
+ * Set the image of @button to the given widget. Note that
+ * it depends on the #GtkSettings:gtk-button-images setting whether the
+ * image will be displayed or not, you don't have to call
  * gtk_widget_show() on @image yourself.
  *
  * Since: 2.6
- */
+ */ 
 void
 gtk_button_set_image (GtkButton *button,
 		      GtkWidget *image)
@@ -2793,8 +2853,8 @@ gtk_button_get_image_position (GtkButton *button)
  * @button: a #GtkButton
  * @always_show: %TRUE if the menuitem should always show the image
  *
- * If %TRUE, the button will always show the image in addition to the
- * label, if available.
+ * If %TRUE, the button will ignore the #GtkSettings:gtk-button-images
+ * setting and always show the image, if available.
  *
  * Use this property if the button  would be useless or hard to use
  * without the image.
@@ -2831,8 +2891,8 @@ gtk_button_set_always_show_image (GtkButton *button,
  * gtk_button_get_always_show_image:
  * @button: a #GtkButton
  *
- * Returns whether the button will always show the image in addition
- * to the label, if available.
+ * Returns whether the button will ignore the #GtkSettings:gtk-button-images
+ * setting and always show the image, if available.
  *
  * Returns: %TRUE if the button will always show the image
  *
diff --git a/gtk/gtksettings.c b/gtk/gtksettings.c
index 23a3a52..ca9f7dc 100644
--- a/gtk/gtksettings.c
+++ b/gtk/gtksettings.c
@@ -1305,15 +1305,13 @@ gtk_settings_class_init (GtkSettingsClass *class)
    * Whether images should be shown on buttons
    *
    * Since: 2.4
-   *
-   * Deprecated: 3.10: This setting is ignored
    */
   result = settings_install_property_parser (class,
                                              g_param_spec_boolean ("gtk-button-images",
                                                                    P_("Show button images"),
                                                                    P_("Whether images should be shown on buttons"),
-                                                                   FALSE,
-                                                                   GTK_PARAM_READWRITE | G_PARAM_DEPRECATED),
+                                                                   TRUE,
+                                                                   GTK_PARAM_READWRITE),
                                              NULL);
   g_assert (result == PROP_BUTTON_IMAGES);
 
-- 
1.8.4

