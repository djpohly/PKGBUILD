From 98f7a34b17a2cd9a6b23af46064f4f2485601004 Mon Sep 17 00:00:00 2001
From: Olivier Brunel <jjk@jjacky.com>
Date: Sat, 3 Jun 2017 22:10:37 +0200
Subject: [PATCH 09/10] prefs: add option "Ignore sort direction / Make sort
 order aware"

When enabled, we get the old/classic claws behavior, where first means
last, next means previous & previous means last if sorted descending.

When disabled, things make sense. :)

It affects default selection when opening folder, go to previous/next
{,unread,marked,etc} message and next_on_delete behavior.
---
 src/prefs_common.c    |   3 +
 src/prefs_common.h    |   2 +
 src/prefs_summaries.c |  15 +++++
 src/summaryview.c     | 155 ++++++++++++++++++++++++++------------------------
 4 files changed, 101 insertions(+), 74 deletions(-)

diff --git a/src/prefs_common.c b/src/prefs_common.c
index 5a5ee4fd9..5f53ee813 100644
--- a/src/prefs_common.c
+++ b/src/prefs_common.c
@@ -798,6 +798,9 @@ static PrefParam param[] = {
 #endif
 	/* {"emulate_emacs", "FALSE", &prefs_common.emulate_emacs, P_BOOL,
 	 NULL, NULL, NULL}, */
+	{"ignore_sort_direction", "FALSE",
+	 &prefs_common.ignore_sort_direction,
+	 P_BOOL, NULL, NULL, NULL},
 	{"open_selected_message_on_folder_open", "FALSE",
 	 &prefs_common.open_selected_on_folder_open,
 	 P_BOOL, NULL, NULL, NULL},
diff --git a/src/prefs_common.h b/src/prefs_common.h
index b94d34ccc..cfb04bea9 100644
--- a/src/prefs_common.h
+++ b/src/prefs_common.h
@@ -363,6 +363,8 @@ struct _PrefsCommon
 	gint statusbar_update_step;
 	gboolean emulate_emacs;
 
+	gboolean ignore_sort_direction;
+
 	gboolean open_selected_on_folder_open;
 	gboolean open_selected_on_search_results;
 	gboolean open_selected_on_prevnext;
diff --git a/src/prefs_summaries.c b/src/prefs_summaries.c
index 7e131dc58..5b11864fd 100644
--- a/src/prefs_summaries.c
+++ b/src/prefs_summaries.c
@@ -64,6 +64,7 @@ typedef struct _SummariesPage
 	GtkWidget *entry_datefmt;
 
 	GtkWidget *checkbtn_reopen_last_folder;
+	GtkWidget *checkbtn_ignore_sort_direction;
 	GtkWidget *checkbtn_always_show_msg;
 	GtkWidget *checkbtn_show_on_folder_open;
 	GtkWidget *checkbtn_show_on_search_results;
@@ -336,6 +337,7 @@ static void prefs_summaries_create_widget(PrefsPage *_page, GtkWindow *window,
 	GtkWidget *hbox_dispitem;
 	GtkWidget *button_dispitem;
 	GtkWidget *checkbtn_reopen_last_folder;
+	GtkWidget *checkbtn_ignore_sort_direction;
 	GtkWidget *checkbtn_always_show_msg;
 	GtkWidget *checkbtn_show_on_folder_open;
 	GtkWidget *checkbtn_show_on_search_results;
@@ -476,6 +478,13 @@ static void prefs_summaries_create_widget(PrefsPage *_page, GtkWindow *window,
 			  G_CALLBACK (prefs_summary_open_open),
 			  NULL);
 
+	PACK_CHECK_BUTTON
+		(vbox2, checkbtn_ignore_sort_direction,
+		 _("Ignore sort direction / Make sort order aware"));
+	gtk_widget_set_tooltip_text (checkbtn_ignore_sort_direction,
+		_("When enabled, certain features (default selection when entering folder, go to previous/next features, etc) "
+			"will work in reverse when sorted descending: first becomes last, go next becomes go previous, etc"));
+
 	/* Next Unread Message Dialog */
 	hbox1 = gtk_hbox_new (FALSE, 10);
 	gtk_widget_show (hbox1);
@@ -619,6 +628,7 @@ static void prefs_summaries_create_widget(PrefsPage *_page, GtkWindow *window,
 	prefs_summaries->checkbtn_threadsubj = checkbtn_threadsubj;
 	prefs_summaries->entry_datefmt = entry_datefmt;
 	prefs_summaries->checkbtn_reopen_last_folder = checkbtn_reopen_last_folder;
+	prefs_summaries->checkbtn_ignore_sort_direction = checkbtn_ignore_sort_direction;
 
 	prefs_summaries->checkbtn_always_show_msg = checkbtn_always_show_msg;
 	prefs_summaries->checkbtn_show_on_folder_open = checkbtn_show_on_folder_open;
@@ -661,6 +671,8 @@ static void prefs_summaries_create_widget(PrefsPage *_page, GtkWindow *window,
 			prefs_common.date_format?prefs_common.date_format:"");	
 	gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(checkbtn_reopen_last_folder),
 			prefs_common.goto_last_folder_on_startup);
+	gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(checkbtn_ignore_sort_direction),
+			prefs_common.ignore_sort_direction);
 
 	gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(checkbtn_always_show_msg),
 			prefs_common.always_show_msg);
@@ -720,6 +732,9 @@ static void prefs_summaries_save(PrefsPage *_page)
 	prefs_common.goto_last_folder_on_startup = gtk_toggle_button_get_active(
 		GTK_TOGGLE_BUTTON(page->checkbtn_reopen_last_folder));
 
+	prefs_common.ignore_sort_direction = gtk_toggle_button_get_active(
+		GTK_TOGGLE_BUTTON(page->checkbtn_ignore_sort_direction));
+
 	prefs_common.always_show_msg = gtk_toggle_button_get_active(
 		GTK_TOGGLE_BUTTON(page->checkbtn_always_show_msg));
 	prefs_common.open_selected_on_folder_open = gtk_toggle_button_get_active(
diff --git a/src/summaryview.c b/src/summaryview.c
index be44ce6df..8049f0a46 100644
--- a/src/summaryview.c
+++ b/src/summaryview.c
@@ -1477,7 +1477,8 @@ gboolean summary_show(SummaryView *summaryview, FolderItem *item)
 				if (node == NULL && GTK_CMCLIST(ctree)->row_list != NULL)
 					node = gtk_cmctree_node_nth
 						(ctree,
-						 item->sort_type == SORT_DESCENDING
+						 prefs_common.ignore_sort_direction
+						 && item->sort_type == SORT_DESCENDING
 						 ? 0 : GTK_CMCLIST(ctree)->rows - 1);
 				summary_unlock(summaryview);
 
@@ -1495,7 +1496,8 @@ gboolean summary_show(SummaryView *summaryview, FolderItem *item)
 			if (GTK_CMCLIST(ctree)->row_list != NULL)
 				node = gtk_cmctree_node_nth
 					(ctree,
-					 item->sort_type == SORT_DESCENDING
+					 prefs_common.ignore_sort_direction
+					 && item->sort_type == SORT_DESCENDING
 					 ? 0 : GTK_CMCLIST(ctree)->rows - 1);
 			summary_select_node(summaryview, node, OPEN_SELECTED_ON_SEARCH_RESULTS);
 		}
@@ -1519,28 +1521,31 @@ gboolean summary_show(SummaryView *summaryview, FolderItem *item)
 			
 			switch(act) {
 			case ACTION_MARKED:
-				if (summaryview->sort_type == SORT_ASCENDING)
-					node = summary_find_next_flagged_msg(summaryview, NULL,
-					     MSG_MARKED, FALSE);
+				if (prefs_common.ignore_sort_direction
+					&& item->sort_type == SORT_DESCENDING)
+					node = summary_find_prev_flagged_msg
+						(summaryview, NULL, MSG_MARKED, FALSE);
 				else
-					node = summary_find_prev_flagged_msg(summaryview, NULL,
-					     MSG_MARKED, FALSE);
+					node = summary_find_next_flagged_msg
+						(summaryview, NULL, MSG_MARKED, FALSE);
 				break;
 			case ACTION_NEW:
-				if (summaryview->sort_type == SORT_ASCENDING)
-					node = summary_find_next_flagged_msg(summaryview, NULL,
-					     MSG_NEW, FALSE);
+				if (prefs_common.ignore_sort_direction &&
+					item->sort_type == SORT_DESCENDING)
+					node = summary_find_prev_flagged_msg
+						(summaryview, NULL, MSG_NEW, FALSE);
 				else
-					node = summary_find_prev_flagged_msg(summaryview, NULL,
-					     MSG_NEW, FALSE);
+					node = summary_find_next_flagged_msg
+						(summaryview, NULL, MSG_NEW, FALSE);
 				break;
 			case ACTION_UNREAD:
-				if (summaryview->sort_type == SORT_ASCENDING)
-					node = summary_find_next_flagged_msg(summaryview, NULL,
-					     MSG_UNREAD, FALSE);
+				if (prefs_common.ignore_sort_direction
+					&& item->sort_type == SORT_DESCENDING)
+					node = summary_find_prev_flagged_msg
+						(summaryview, NULL, MSG_UNREAD, FALSE);
 				else
-					node = summary_find_prev_flagged_msg(summaryview, NULL,
-					     MSG_UNREAD, FALSE);
+					node = summary_find_next_flagged_msg
+						(summaryview, NULL, MSG_UNREAD, FALSE);
 				break;
 			case ACTION_LAST_OPENED:
 				if (summaryview->folder_item) {
@@ -1552,7 +1557,8 @@ gboolean summary_show(SummaryView *summaryview, FolderItem *item)
 				if (GTK_CMCLIST(ctree)->row_list != NULL) {
 					node = gtk_cmctree_node_nth
 						(ctree,
-						 item->sort_type == SORT_DESCENDING
+						 prefs_common.ignore_sort_direction
+						 && item->sort_type == SORT_DESCENDING
 						 ? 0 : GTK_CMCLIST(ctree)->rows - 1);
 				}
 				break;
@@ -1560,8 +1566,9 @@ gboolean summary_show(SummaryView *summaryview, FolderItem *item)
 				if (GTK_CMCLIST(ctree)->row_list != NULL) {
 					node = gtk_cmctree_node_nth
 						(ctree,
-						 item->sort_type == SORT_ASCENDING
-						 ? 0 : GTK_CMCLIST(ctree)->rows - 1);
+						 prefs_common.ignore_sort_direction
+						 && item->sort_type == SORT_DESCENDING
+						 ? GTK_CMCLIST(ctree)->rows - 1 : 0);
 				}
 				break;
 			case ACTION_NOTHING:
@@ -1841,10 +1848,10 @@ void summary_select_prev(SummaryView *summaryview)
 	GtkCMCTreeNode *node = summaryview->selected;
 	GtkCMCTree *ctree = GTK_CMCTREE(summaryview->ctree);
 
-	if (summaryview->sort_type == SORT_ASCENDING)
-		node = gtkut_ctree_node_prev(ctree, node);
-	else
+	if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
 		node = gtkut_ctree_node_next(ctree, node);
+	else
+		node = gtkut_ctree_node_prev(ctree, node);
 
 	if (node && node != summaryview->selected)
 		summary_select_node(summaryview, node, OPEN_SELECTED_ON_PREVNEXT);
@@ -1855,10 +1862,10 @@ void summary_select_next(SummaryView *summaryview)
 	GtkCMCTreeNode *node = summaryview->selected;
 	GtkCMCTree *ctree = GTK_CMCTREE(summaryview->ctree);
 
-	if (summaryview->sort_type == SORT_ASCENDING)
-		node = gtkut_ctree_node_next(ctree, node);
-	else
+	if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
 		node = gtkut_ctree_node_prev(ctree, node);
+	else
+		node = gtkut_ctree_node_next(ctree, node);
 
 	if (node && node != summaryview->selected)
 		summary_select_node(summaryview, node, OPEN_SELECTED_ON_PREVNEXT);
@@ -1868,11 +1875,11 @@ void summary_select_prev_unread(SummaryView *summaryview)
 {
 	GtkCMCTreeNode *node;
 
-	if (summaryview->sort_type == SORT_ASCENDING)
-		node = summary_find_prev_flagged_msg
+	if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
+		node = summary_find_next_flagged_msg
 			(summaryview, summaryview->selected, MSG_UNREAD, TRUE);
 	else
-		node = summary_find_next_flagged_msg
+		node = summary_find_prev_flagged_msg
 			(summaryview, summaryview->selected, MSG_UNREAD, TRUE);
 
 	if (!node || node == summaryview->selected) {
@@ -1896,11 +1903,11 @@ void summary_select_prev_unread(SummaryView *summaryview)
  					_("Internal error: unexpected value for prefs_common.next_unread_msg_dialog\n"));
  		}
 		if (val != G_ALERTALTERNATE) return;
-		if (summaryview->sort_type == SORT_ASCENDING)
-			node = summary_find_prev_flagged_msg(summaryview, NULL,
+		if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
+			node = summary_find_next_flagged_msg(summaryview, NULL,
 							     MSG_UNREAD, FALSE);
 		else
-			node = summary_find_next_flagged_msg(summaryview, NULL,
+			node = summary_find_prev_flagged_msg(summaryview, NULL,
 							     MSG_UNREAD, FALSE);
 	}
 
@@ -1914,11 +1921,11 @@ void summary_select_next_unread(SummaryView *summaryview)
 {
 	GtkCMCTreeNode *node = summaryview->selected;
 
-	if (summaryview->sort_type == SORT_ASCENDING)
-		node = summary_find_next_flagged_msg
+	if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
+		node = summary_find_prev_flagged_msg
 			(summaryview, node, MSG_UNREAD, TRUE);
 	else
-		node = summary_find_prev_flagged_msg
+		node = summary_find_next_flagged_msg
 			(summaryview, node, MSG_UNREAD, TRUE);
 	
 	if (node)
@@ -1953,11 +1960,11 @@ void summary_select_prev_new(SummaryView *summaryview)
 {
 	GtkCMCTreeNode *node;
 
-	if (summaryview->sort_type == SORT_ASCENDING)
-		node = summary_find_prev_flagged_msg
+	if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
+		node = summary_find_next_flagged_msg
 			(summaryview, summaryview->selected, MSG_NEW, TRUE);
 	else
-		node = summary_find_next_flagged_msg
+		node = summary_find_prev_flagged_msg
 			(summaryview, summaryview->selected, MSG_NEW, TRUE);
 
 	if (!node || node == summaryview->selected) {
@@ -1981,11 +1988,11 @@ void summary_select_prev_new(SummaryView *summaryview)
  					_("Internal error: unexpected value for prefs_common.next_unread_msg_dialog\n"));
  		}
 		if (val != G_ALERTALTERNATE) return;
-		if (summaryview->sort_type == SORT_ASCENDING)
-			node = summary_find_prev_flagged_msg(summaryview, NULL,
+		if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
+			node = summary_find_next_flagged_msg(summaryview, NULL,
 						     	     MSG_NEW, FALSE);
 		else
-			node = summary_find_next_flagged_msg(summaryview, NULL,
+			node = summary_find_prev_flagged_msg(summaryview, NULL,
 							     MSG_NEW, FALSE);
 	}
 
@@ -1999,11 +2006,11 @@ void summary_select_next_new(SummaryView *summaryview)
 {
 	GtkCMCTreeNode *node = summaryview->selected;
 
-	if (summaryview->sort_type == SORT_ASCENDING)
-		node = summary_find_next_flagged_msg
+	if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
+		node = summary_find_prev_flagged_msg
 			(summaryview, node, MSG_NEW, TRUE);
 	else
-		node = summary_find_prev_flagged_msg
+		node = summary_find_next_flagged_msg
 			(summaryview, node, MSG_NEW, TRUE);
 	
 	if (node)
@@ -2037,11 +2044,11 @@ void summary_select_prev_marked(SummaryView *summaryview)
 {
 	GtkCMCTreeNode *node;
 
-	if (summaryview->sort_type == SORT_ASCENDING)
-		node = summary_find_prev_flagged_msg
+	if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
+		node = summary_find_next_flagged_msg
 			(summaryview, summaryview->selected, MSG_MARKED, TRUE);
 	else
-		node = summary_find_next_flagged_msg
+		node = summary_find_prev_flagged_msg
 			(summaryview, summaryview->selected, MSG_MARKED, TRUE);
 
 	if (!node) {
@@ -2066,11 +2073,11 @@ void summary_select_next_marked(SummaryView *summaryview)
 {
 	GtkCMCTreeNode *node = summaryview->selected;
 
-	if (summaryview->sort_type == SORT_ASCENDING)
-		node = summary_find_next_flagged_msg
+	if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
+		node = summary_find_prev_flagged_msg
 			(summaryview, node, MSG_MARKED, TRUE);
 	else
-		node = summary_find_prev_flagged_msg
+		node = summary_find_next_flagged_msg
 			(summaryview, node, MSG_MARKED, TRUE);
 	
 	if (node)
@@ -2104,11 +2111,11 @@ void summary_select_prev_labeled(SummaryView *summaryview)
 {
 	GtkCMCTreeNode *node;
 
-	if (summaryview->sort_type == SORT_ASCENDING)
-		node = summary_find_prev_flagged_msg
+	if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
+		node = summary_find_next_flagged_msg
 			(summaryview, summaryview->selected, MSG_CLABEL_FLAG_MASK, TRUE);
 	else
-		node = summary_find_next_flagged_msg
+		node = summary_find_prev_flagged_msg
 			(summaryview, summaryview->selected, MSG_CLABEL_FLAG_MASK, TRUE);
 
 	if (!node) {
@@ -2133,11 +2140,11 @@ void summary_select_next_labeled(SummaryView *summaryview)
 {
 	GtkCMCTreeNode *node;
 
-	if (summaryview->sort_type == SORT_ASCENDING)
-		node = summary_find_next_flagged_msg
+	if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
+		node = summary_find_prev_flagged_msg
 			(summaryview, summaryview->selected, MSG_CLABEL_FLAG_MASK, TRUE);
 	else
-		node = summary_find_prev_flagged_msg
+		node = summary_find_next_flagged_msg
 			(summaryview, summaryview->selected, MSG_CLABEL_FLAG_MASK, TRUE);
 
 	if (!node) {
@@ -2148,11 +2155,11 @@ void summary_select_next_labeled(SummaryView *summaryview)
 				   "Search from the beginning?"),
 				 GTK_STOCK_NO, "+"GTK_STOCK_YES, NULL);
 		if (val != G_ALERTALTERNATE) return;
-		if (summaryview->sort_type == SORT_ASCENDING)
-			node = summary_find_next_flagged_msg(summaryview, NULL,
+		if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING)
+			node = summary_find_prev_flagged_msg(summaryview, NULL,
 						    	     MSG_CLABEL_FLAG_MASK, TRUE);
 		else
-			node = summary_find_prev_flagged_msg(summaryview, NULL,
+			node = summary_find_next_flagged_msg(summaryview, NULL,
 						    	     MSG_CLABEL_FLAG_MASK, TRUE);
 	}
 
@@ -4477,14 +4484,14 @@ void summary_delete(SummaryView *summaryview)
 	folder_item_set_batch(summaryview->folder_item, FALSE);
 	END_LONG_OPERATION(summaryview);
 
-	if (summaryview->sort_type == SORT_ASCENDING) {
-		node = summary_find_next_msg(summaryview, sel_last, TRUE);
+	if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING) {
+		node = summary_find_prev_msg(summaryview, sel_last, TRUE);
 		if (!node || prefs_common.next_on_delete == FALSE)
-			node = summary_find_prev_msg(summaryview, sel_last,TRUE);
+			node = summary_find_next_msg(summaryview, sel_last,TRUE);
 	} else {
-		node = summary_find_prev_msg(summaryview, sel_last,TRUE);
+		node = summary_find_next_msg(summaryview, sel_last,TRUE);
 		if (!node || prefs_common.next_on_delete == FALSE)
-			node = summary_find_next_msg(summaryview, sel_last,TRUE);
+			node = summary_find_prev_msg(summaryview, sel_last,TRUE);
 	}
 	summary_select_node(summaryview, node, OPEN_SELECTED_ON_DELETEMOVE);
 	
@@ -4634,14 +4641,14 @@ void summary_move_selected_to(SummaryView *summaryview, FolderItem *to_folder)
 		summary_execute(summaryview);
 	} else {
 		GtkCMCTreeNode *node = NULL;
-		if (summaryview->sort_type == SORT_ASCENDING) {
-			node = summary_find_next_msg(summaryview, sel_last,TRUE);
-			if (!node || prefs_common.next_on_delete == FALSE)
-				node = summary_find_prev_msg(summaryview, sel_last,TRUE);
-		} else {
+		if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING) {
 			node = summary_find_prev_msg(summaryview, sel_last,TRUE);
 			if (!node || prefs_common.next_on_delete == FALSE)
 				node = summary_find_next_msg(summaryview, sel_last,TRUE);
+		} else {
+			node = summary_find_next_msg(summaryview, sel_last,TRUE);
+			if (!node || prefs_common.next_on_delete == FALSE)
+				node = summary_find_prev_msg(summaryview, sel_last,TRUE);
 		}
 		summary_select_node(summaryview, node, OPEN_SELECTED_ON_DELETEMOVE);
 		summary_status_show(summaryview);
@@ -5014,14 +5021,14 @@ gboolean summary_execute(SummaryView *summaryview)
 		if (!new_selected &&
 		    gtkut_ctree_node_is_selected(ctree, node)) {
 			summary_unselect_all(summaryview);
-			if (summaryview->sort_type == SORT_ASCENDING) {
-				new_selected = summary_find_next_msg(summaryview, node,TRUE);
-				if (!new_selected || prefs_common.next_on_delete == FALSE)
-					new_selected = summary_find_prev_msg(summaryview, node,TRUE);
-			} else {
+			if (prefs_common.ignore_sort_direction && summaryview->sort_type == SORT_DESCENDING) {
 				new_selected = summary_find_prev_msg(summaryview, node,TRUE);
 				if (!new_selected || prefs_common.next_on_delete == FALSE)
 					new_selected = summary_find_next_msg(summaryview, node,TRUE);
+			} else {
+				new_selected = summary_find_next_msg(summaryview, node,TRUE);
+				if (!new_selected || prefs_common.next_on_delete == FALSE)
+					new_selected = summary_find_prev_msg(summaryview, node,TRUE);
 			}
 		}
 
-- 
2.15.1

