From 7496f268f8688eed161243064afa2b91c8ff3d30 Mon Sep 17 00:00:00 2001
From: Jakub Kicinski <kubakici@wp.pl>
Date: Wed, 11 Dec 2013 18:12:05 +0100
Subject: [PATCH 2/8] Add coloring of diff patches inside emails.

Signed-off-by: Olivier Brunel <jjk@jjacky.com>
---
 src/textview.c | 11 ++++++++++-
 src/textview.h |  1 +
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/src/textview.c b/src/textview.c
index c23c68606..1e7ade8b4 100644
--- a/src/textview.c
+++ b/src/textview.c
@@ -1074,6 +1074,7 @@ static void textview_write_body(TextView *textview, MimeInfo *mimeinfo)
 	
 	textview->is_in_signature = FALSE;
 	textview->is_diff = FALSE;
+	textview->is_in_git_patch = FALSE;
 
 	procmime_decode_content(mimeinfo);
 
@@ -1619,7 +1620,7 @@ static void textview_write_line(TextView *textview, const gchar *str,
 	}
 
 	if (prefs_common.enable_color) {
-		if (textview->is_diff) {
+		if (textview->is_diff || textview->is_in_git_patch) {
 			if (strncmp(buf, "+++ ", 4) == 0)
 				fg_color = "diff-add-file";
 			else if (buf[0] == '+')
@@ -1631,11 +1632,19 @@ static void textview_write_line(TextView *textview, const gchar *str,
 			else if (strncmp(buf, "@@ ", 3) == 0 &&
 				 strstr(&buf[3], " @@"))
 				fg_color = "diff-hunk";
+
+			if (strcmp(buf,"-- \n") == 0) {
+				textview->is_in_git_patch = FALSE;
+				textview->is_in_signature = TRUE;
+				fg_color = "signature";
+			}
 		} else if (strcmp(buf,"-- \n") == 0
 				|| strcmp(buf, "- -- \n") == 0
 				|| textview->is_in_signature) {
 			fg_color = "signature";
 			textview->is_in_signature = TRUE;
+		} else if (strncmp(buf, "diff --git ", 11) == 0) {
+			textview->is_in_git_patch = TRUE;
 		}
 	}
 
diff --git a/src/textview.h b/src/textview.h
index 51b7643b4..5864a1dfe 100644
--- a/src/textview.h
+++ b/src/textview.h
@@ -66,6 +66,7 @@ struct _TextView
 	gboolean default_text;
 	gboolean is_in_signature;
 	gboolean is_diff;
+	gboolean is_in_git_patch;
 	
 	GSList *uri_list;
 	gint body_pos;
-- 
2.11.1

