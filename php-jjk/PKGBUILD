# $Id: PKGBUILD 158788 2012-05-09 18:48:29Z pierre $
# Maintainer: Pierre Schmitz <pierre@archlinux.de>

pkgbase=php
pkgname=('php-jjk'
         'php-fpm-jjk')
pkgver=7.1.5
pkgrel=1
arch=('i686' 'x86_64')
license=('PHP')
url='http://www.php.net'
makedepends=('db' 'gmp' 'pcre'
             'libxml2' 'bzip2' 'curl')
source=("https://php.net/distributions/${pkgbase}-${pkgver}.tar.xz"{,.asc}
        'php.ini.patch' 'php-fpm.patch')
validpgpkeys=('A917B1ECDA84AEC2B568FED6F50ABC807BD5DCD0'
              '528995BFEDFBA7191D46839EF9BA0ADA31CBD89E')
sha256sums=('d149a3c396c45611f5dc6bf14be190f464897145a76a8e5851cf18ff7094f6ac'
            'SKIP'
            'e804ac9fcfb10a232d45b5075515fc2f66958831bdf68e1b061eb7dfdf2560ea'
            'b351a9c8c212d8cdd9127c973845501afba9a0d5185a1f3c4a415fb11458d589')

prepare() {
    cd "${srcdir}/${pkgbase}-${pkgver}"

    patch -p0 -i ../php.ini.patch
    patch -p0 -i ../php-fpm.patch
}

build() {
    phpconfig="--srcdir=../${pkgbase}-${pkgver} \
        --config-cache \
        --prefix=/usr \
        --sbindir=/usr/bin \
        --sysconfdir=/etc/php \
        --localstatedir=/var \
        --with-layout=GNU \
        --with-config-file-path=/etc/php \
        --with-config-file-scan-dir=/etc/php/conf.d \
        --disable-rpath \
        --mandir=/usr/share/man \
        --without-pear \
        --enable-zend-signals \
        "

    phpextensions="--enable-bcmath=shared \
        --enable-calendar=shared \
        --enable-dba=shared \
        --enable-exif=shared \
        --enable-ftp=shared \
        --enable-mbstring \
        --enable-shmop=shared \
        --enable-soap=shared \
        --enable-sockets=shared \
        --enable-sysvmsg=shared \
        --enable-sysvsem=shared \
        --enable-sysvshm=shared \
        --enable-zip=shared \
        --with-bz2=shared \
        --with-curl=shared \
        --with-db4=/usr \
        --with-freetype-dir=/usr \
        --with-gd=shared \
        --with-gdbm \
        --with-gettext=shared \
        --with-gmp=shared \
        --with-iconv=shared \
        --with-mhash \
        --with-openssl \
        --with-pcre-regex=/usr \
        --with-xmlrpc=shared \
        --with-zlib \
        --enable-pcntl \
        "

    EXTENSION_DIR=/usr/lib/php/modules
    export EXTENSION_DIR

    mkdir "${srcdir}/build"
    cd "${srcdir}/build"
    ln -s ../${pkgbase}-${pkgver}/configure
    ./configure ${phpconfig} \
        --enable-cgi \
        --enable-fpm \
        --with-fpm-user=http \
        --with-fpm-group=http \
        ${phpextensions}
    make
}

package_php-jjk() {
	pkgdesc='An HTML-embedded scripting language'
	depends=('libxml2' 'bzip2' 'curl' 'pcre')
	provides=('php')
	conflicts=('php')
	backup=('etc/php/php.ini')

	cd "${srcdir}/build"
	make -j1 INSTALL_ROOT="${pkgdir}" install-{modules,cli,build,headers,programs,pharcmd}
	# install php.ini
	install -D -m644 "${srcdir}"/${pkgbase}-${pkgver}/php.ini-production "${pkgdir}"/etc/php/php.ini
	install -d -m755 "${pkgdir}"/etc/php/conf.d/

	# remove static modules
	rm -f "${pkgdir}"/usr/lib/php/modules/*.a
	# remove modules provided by sub packages
	rm -f "${pkgdir}"/usr/lib/php/modules/{enchant,gd,intl,ldap,mcrypt,mssql,odbc,pdo_odbc,pgsql,pdo_pgsql,pspell,snmp,sqlite3,pdo_sqlite,tidy,xsl}.so
	# remove empty directory
	rmdir "${pkgdir}"/usr/include/php/include
}

package_php-fpm-jjk() {
	pkgdesc='FastCGI Process Manager for PHP'
	depends=('php')
	conflicts=('php-fpm')
	backup=('etc/php/php-fpm.conf' 'etc/php/php-fpm.d/www.conf')
    options=('!emptydirs')

    cd "${srcdir}"/build
    make -j1 INSTALL_ROOT="${pkgdir}" install-fpm
}
