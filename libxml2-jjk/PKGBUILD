# $Id$
# Maintainer: Jan de Groot <jgc@archlinux.org>
# Maintainer: Tom Gundersen <teg@jklm.no>
# Contributor: John Proctor <jproctor@prium.net>

_pkgname=libxml2
pkgname=$_pkgname-jjk
pkgver=2.9.6
pkgrel=1
pkgdesc="XML parsing library, version 2"
arch=('i686' 'x86_64')
license=('MIT')
depends=('zlib' 'readline' 'ncurses' 'xz')
options=('!makeflags')
makedepends=('python2' 'python')
provides=($_pkgname=$pkgver)
conflicts=($_pkgname)
url="http://www.xmlsoft.org/"
source=(ftp://xmlsoft.org/libxml2/libxml2-$pkgver.tar.gz{,.asc}
        https://www.w3.org/XML/Test/xmlts20130923.tar.gz
        libxml2-2.9.4-remove-pyverify_fd.patch)
validpgpkeys=('C74415BA7C9C7F78F02E1DC34606B8A5DE95BC1F')
sha256sums=('8b9038cca7240e881d462ea391882092dfdc6d4f483f72683e817be08df5ebbc'
            'SKIP'
            '9b61db9f5dbffa545f4b8d78422167083a8568c59bd1129f94138f936cf6fc1f'
            'c201b0d6364a7b9df58ce40a5fc506e58945a3fbb834af9c1193a35665789d60')

prepare() {
  mkdir build-py3
  mkdir build-py2
  mv xmlconf build-py2/
  cd $_pkgname-$pkgver
  patch -Np1 -i ../libxml2-2.9.4-remove-pyverify_fd.patch
  NOCONFIGURE=1 ./autogen.sh
}

build() {
  cd build-py2
  ../$_pkgname-$pkgver/configure --prefix=/usr --with-threads --with-history \
      --with-python=/usr/bin/python2
  sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0 /g' libtool
  make

  cd ../build-py3
  ../$_pkgname-$pkgver/configure --prefix=/usr --with-threads --with-history \
      --with-python=/usr/bin/python
  sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0 /g' libtool
  PYTHONHASHSEED=0 make
}

check() {
  cd build-py2
  make check
}

package() {
  cd build-py2
  find doc -type f -exec chmod 0644 {} \;

  make DESTDIR="$pkgdir" install
  install -Dm644 COPYING "$pkgdir/usr/share/licenses/$_pkgname/COPYING"

  cd ../build-py3/python
  PYTHONHASHSEED=0 make DESTDIR="$pkgdir" install
}
